<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Products</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@500&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
    <aside class="sidebar">
        <div class="logo">
        </div>
        <ul class="navigation">
            <li><a href="index.html"><i class="fas fa-home"></i></a></li>
            <li><a href="#" class="active"><i class="fas fa-box"></i></a></li>
            <li><a href="map.html"><i class="fas fa-map"></i></a></li>
            <li><a href="#"><i class="fas fa-cog"></i></a></li>
            <li><a href="#"><i class="fas fa-user"></i></a></li>
        </ul>
    </aside>

    <main class="content">
        <section class="home-section">
            <div class="background-image">
                <div class="dim-overlay"></div>
            </div>
            <div class="stocks-section">
                <div class="stocks-container">
                    <div class="control-container">
                        <div class="control">
                            <span>Add a Product</span>
                            <i class="fa-regular fa-map" id="toggle-icon"></i>
                            <div class="popup-background" id="popupBackground">
                                <div class="popup-window">
                                    <img id="popupImage" class="popup-image">
                                </div>
                            </div>
                            <br><br>

                            <label for="prodId">ID:</label>
                            <input type="text" id="prodId" value="" placeholder="">
                            <label for="prodBrand">Brand:</label>
                            <input type="text" id="prodBrand" value="" placeholder="">
                            <label for="prodName">Name:</label>
                            <input type="text" id="prodName" value="" placeholder="">
                            <br>
                            <label for="prodPrice">Price:</label>
                            <input type="text" id="prodPrice" value="" placeholder="">
                            <label for="prodStock">Stocks:</label>
                            <input type="text" id="prodStock" value="" placeholder="">
                            <label for="prodImage">Image:</label>
                            <input type="file" id="prodImage">
                            <br>
                            <label for="prodAisle">Aisle:</label>
                            <input type="text" id="prodAisle" value="" placeholder="">
                            <label for="prodCategory">Category:</label>
                            <select id="prodCategory">
                                <option value="Cans">Cans</option>
                                <option value="Snacks">Snacks</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Bakery">Bakery</option>
                                <option value="Breakfast">Breakfast</option>
                                <option value="Baking-Cooking">Baking & Cooking</option>
                                <option value="Condiments-Sauces">Condiments & Sauces</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Frozen-Food">Frozen Food</option>
                                <option value="Baby-Items">Baby Items</option>
                                <option value="Toiletries">Toiletries</option>
                                <option value="Personal-Care">Personal Care</option>
                                <option value="Beauty">Beauty</option>
                                <option value="Medicinal">Medicinal</option>
                                <option value="Cleaners">Cleaners</option>
                                <option value="Household-Variety">Household Variety</option>
                            </select>
                            <br><br>
                            <label for="prodDescription">Description:</label>
                            <br>
                            <input type="text" id="prodDescription" value=""></input>
                            <button id="addProd">Add</button>
                        </div>

                        <div class="control">
                            <span>Remove a Product</span><br><br>
                            <label for="delProdId">ID:</label>
                            <input type="text" id="delProdId" value="" placeholder="">
                            <button id="deleteProd">Delete</button>
                        </div>
                        <div class="control">
                            <span>Update a Product</span><br><br>
                            <label for="updProdId">ID:</label>
                            <input type="text" id="updProdId" value="" placeholder="">
                            <button id="searchProd">Search</button>
                            <br><br>
                            <label for="updProdBrand">Brand:</label>
                            <input type="text" id="updProdBrand" value="" placeholder="">
                            <label for="updProdName">Name:</label>
                            <input type="text" id="updProdName" value="" placeholder="">
                            <label for="updProdPrice">Price:</label>
                            <input type="text" id="updProdPrice" value="" placeholder="">
                            <br>
                            <label for="updProdStock">Stocks:</label>
                            <input type="text" id="updProdStock" value="" placeholder="">
                            <label for="updProdName">Aisle:</label>
                            <input type="text" id="updProdAisle" value="" placeholder="">
                            <label for="updProdImage">Image:</label>
                            <input type="file" id="updProdImage">
                            <br>
                            <label for="updProdCategory">Category:</label>
                            <select id="updProdCategory">
                                <option value="Cans">Cans</option>
                                <option value="Snacks">Snacks</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Bakery">Bakery</option>
                                <option value="Breakfast">Breakfast</option>
                                <option value="Baking-Cooking">Baking & Cooking</option>
                                <option value="Condiments-Sauces">Condiments & Sauces</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Frozen-Food">Frozen Food</option>
                                <option value="Baby-Items">Baby Items</option>
                                <option value="Toiletries">Toiletries</option>
                                <option value="Personal-Care">Personal Care</option>
                                <option value="Beauty">Beauty</option>
                                <option value="Medicinal">Medicinal</option>
                                <option value="Cleaners">Cleaners</option>
                                <option value="Household-Variety">Household Variety</option>
                                <option value="Hardware">Hardware</option>
                            </select>
                            <br><br>
                            <label for="updProdDescription">Description:</label>
                            <br>
                            <input id="updProdDescription" placeholder=""></input>
                            <button id="updateProd">Update</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="productsTable" class="stock-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Brand</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Stocks Available</th>
                                    <th>Aisle</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Image</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.js"></script>
    <script src="script/popup.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDwGNnr89LQuf5X4T84vRUsFWRa5rAjU34",
            authDomain: "shopeasy-00021.firebaseapp.com",
            projectId: "shopeasy-00021",
            storageBucket: "shopeasy-00021.appspot.com",
            messagingSenderId: "571722682332",
            appId: "1:571722682332:web:cea4a3cac463b0ad22c919",
            measurementId: "G-MXGEGHRB7Q"
        };

        firebase.initializeApp(firebaseConfig);

        const db = firebase.database();

        $(document).ready(function () {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    const imageRef = db.ref("grocery_stores/" + user.uid + "/map/map_image");

                    imageRef.once("value").then(snapshot => {
                        const imageUrl = snapshot.val();
                        if (imageUrl) {
                            document.getElementById("popupImage").src = imageUrl;
                        }
                    });

                    let isPopupVisible = false;
                    let scale = 1;
                    let translateX = 0;
                    let translateY = 0;
                    let startX, startY, isDragging = false;

                    const toggleIcon = document.getElementById("toggle-icon");
                    const popupBackground = document.getElementById("popupBackground");
                    const popupImage = document.getElementById("popupImage");

                    toggleIcon.addEventListener("click", () => {
                        isPopupVisible = !isPopupVisible;
                        popupBackground.style.display = isPopupVisible ? "block" : "none";
                        resetImage();
                    });

                    popupImage.addEventListener("wheel", (e) => {
                        e.preventDefault();
                        const zoomIntensity = 0.3;
                        scale += e.deltaY < 0 ? zoomIntensity : -zoomIntensity;
                        scale = Math.max(1, Math.min(scale, 4));
                        updateTransform();
                    });

                    popupImage.addEventListener("mousedown", (e) => {
                        isDragging = true;
                        startX = e.clientX - translateX;
                        startY = e.clientY - translateY;
                        popupImage.style.cursor = "grabbing";
                    });

                    document.addEventListener("mouseup", () => {
                        isDragging = false;
                        popupImage.style.cursor = "grab";
                    });

                    document.addEventListener("mousemove", (e) => {
                        if (isDragging) {
                            translateX = e.clientX - startX;
                            translateY = e.clientY - startY;
                            updateTransform();
                        }
                    });

                    function updateTransform() {
                        popupImage.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                    }

                    function resetImage() {
                        scale = 1;
                        translateX = 0;
                        translateY = 0;
                        updateTransform();
                    }


                    // Add Product
                    $("#addProd").click(function () {
                        var prodID = $("#prodId").val();
                        var prodBrand = $("#prodBrand").val();
                        var prodName = $("#prodName").val();
                        var prodPrice = $("#prodPrice").val();
                        var prodStock = $("#prodStock").val();
                        var prodAisle = $("#prodAisle").val();
                        var prodCategory = $("#prodCategory").val();
                        var prodDescription = $("#prodDescription").val();
                        var file = document.getElementById('prodImage').files[0];

                        const reader = new FileReader();
                        reader.onload = function (event) {
                            const base64Image = event.target.result;
                            db.ref("grocery_stores/" + user.uid + "/products/" + prodID).set({
                                productBrand: prodBrand,
                                productName: prodName,
                                productPrice: prodPrice,
                                productStock: prodStock,
                                productAisle: prodAisle,
                                productCategory: prodCategory,
                                productDescription: prodDescription,
                                productImage: base64Image,
                            })
                                .then(() => {
                                    alert("Product added successfully!");
                                    location.reload();
                                })
                                .catch((error) => {
                                    console.log("Error adding product:", error);
                                });
                        };

                        reader.readAsDataURL(file);
                    });

                    // Delete Product
                    $("#deleteProd").click(function () {
                        var prodID = $("#delProdId").val().trim();

                        if (prodID === "") {
                            alert("Please enter a valid product ID.");
                            return;
                        }

                        db.ref("grocery_stores/" + user.uid + "/products/" + prodID).once('value')
                            .then((snapshot) => {
                                if (snapshot.exists()) {
                                    db.ref("grocery_stores/" + user.uid + "/products/" + prodID).remove()
                                        .then(() => {
                                            alert("Product deleted successfully!");
                                            location.reload();
                                        })
                                        .catch((error) => {
                                            console.log("Error deleting product:", error);
                                        });
                                } else {
                                    alert("Product ID not found. Please enter a valid product ID.");
                                }
                            })
                            .catch((error) => {
                                console.log("Error checking product:", error);
                            });
                    });


                    // Search Product
                    $("#searchProd").click(function () {
                        var prodID = $("#updProdId").val();

                        if (prodID === "") {
                            alert("Please enter a valid product ID.");
                            return;
                        }

                        const stock = db.ref("grocery_stores/" + user.uid + "/products/" + prodID);

                        stock.once("value").then((snapshot) => {
                            const data = snapshot.val();
                            if (data) {
                                $("#updProdBrand").val(data.productBrand);
                                $("#updProdName").val(data.productName);
                                $("#updProdPrice").val(data.productPrice);
                                $("#updProdStock").val(data.productStock);
                                $("#updProdAisle").val(data.productAisle);
                                $("#updProdCategory").val(data.productCategory);
                                $("#updProdDescription").val(data.productDescription);
                                $("#updProdImage").attr("src", data.productImage);
                            } else {
                                alert("Product not found.");
                            }
                        }).catch((error) => {
                            console.log("Error searching product:", error);
                        });
                    });

                    // Update Product
                    $("#updateProd").click(function () {
                        var prodID = $("#updProdId").val();
                        var prodBrand = $("#updProdBrand").val();
                        var prodName = $("#updProdName").val();
                        var prodPrice = $("#updProdPrice").val();
                        var prodStock = $("#updProdStock").val();
                        var prodAisle = $("#updProdAisle").val();
                        var prodCategory = $("#updProdCategory").val();
                        var prodDescription = $("#updProdDescription").val();
                        var prodImage = $("#updProdImage").attr("src");

                        db.ref("grocery_stores/" + user.uid + "/products/" + prodID).update({
                            productBrand: prodBrand,
                            productName: prodName,
                            productPrice: prodPrice,
                            productStock: prodStock,
                            productAisle: prodAisle,
                            productCategory: prodCategory,
                            productDescription: prodDescription,
                            productImage: prodImage,
                        })
                            .then(() => {
                                alert("Product updated successfully!");
                                location.reload();
                            })
                            .catch((error) => {
                                console.log("Error updating product:", error);
                            });
                    });

                    // Display Products
                    const productsRef = db.ref("grocery_stores/" + user.uid + "/products/");

                    productsRef.on("value", snapshot => {
                        const productsTable = document.getElementById("productsTable").getElementsByTagName('tbody')[0];
                        productsTable.innerHTML = '';

                        snapshot.forEach(childSnapshot => {
                            const productData = childSnapshot.val();

                            const newRow = productsTable.insertRow();
                            newRow.innerHTML = `
                         <td>${childSnapshot.key}</td>
                         <td>${productData.productBrand}</td>
                         <td>${productData.productName}</td>
                         <td>${productData.productPrice}</td>
                         <td>${productData.productStock}</td>
                         <td>${productData.productAisle}</td>
                         <td>${productData.productCategory}</td>
                         <td>${productData.productDescription}</td>
                         <td><img src="${productData.productImage}" width="50" height="50" alt="Product Image"></td>
                     `;
                        });
                    });
                } else {
                    alert("User is not authenticated. Please sign in.");
                    window.location = "login.html";
                }
            });
        });

    </script>
</body>

</html>